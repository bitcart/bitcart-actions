name: Lint

on:
  workflow_call:
    inputs:
      install-dependencies:
        description: "Command to install project dependencies"
        type: string
        default: ""
      extra-checks:
        description: "Extra checks to run before prek"
        type: string
        default: ""
      cache-run-data:
        description: "Cache prek repositories and data"
        type: boolean
        default: true
      cache-dependency-glob:
        description: "Glob pattern for uv cache. Use empty string to disable, omit to use uv default."
        type: string
        default: |
          **/pyproject.toml
          **/uv.lock
      run-zizmor:
        description: "Run zizmor security audit on GitHub Actions workflows"
        type: boolean
        default: false

permissions: {}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up Python
        uses: bitcart/bitcart-actions/actions/setup-python@master
        with:
          cache-dependency-glob: ${{ inputs.install-dependencies == '' && '' || inputs.cache-dependency-glob }}

      - name: Install dependencies
        run: ${{ inputs.install-dependencies || 'uv pip install prek' }}

      - name: Extra checks
        if: inputs.extra-checks != ''
        run: ${{ inputs.extra-checks }}

      - name: Cache prek repos
        if: inputs.cache-run-data
        uses: actions/cache@v5
        with:
          path: ~/.cache/prek
          key: v1-lint-${{ github.ref_name }}-prek-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            v1-lint-${{ github.ref_name }}-prek-

      - name: Run prek checks
        run: prek run --all-files --show-diff-on-failure

      - name: Prune prek cache
        run: |
          prek cache gc -v || echo "Failed to prune prek cache"

  zizmor:
    if: inputs.run-zizmor
    runs-on: ubuntu-latest

    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Run zizmor
        uses: zizmorcore/zizmor-action@v0.5.0
